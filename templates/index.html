<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Medical & Billing Agentic AI Analyzer</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #E3F0FF, #FFFFFF);
            min-height: 100vh;
            padding: 20px;
        }

        .container-box {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }

        #progress-box {
            display: none;
        }

        #result-box {
            display: none;
        }

        .loader {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            transition: width 0.6s ease;
        }

        #toast-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 99999;
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <div class="container col-md-9 mt-4">
        <div class="container-box">
            <h2 class="text-center mb-3">┖ Medical &  Billing Agentic AI Analyzer</h2>
            <p class="text-center text-muted">
                Upload a medical report or hospital bill (PDF or image).
                Our multi-agent AI will:
                <br>
                 Detect document type 路 explain like a doctor 路 give health or billing guidance 路 visualize lab values
                when possible 路 and translate into your language.
            </p>

            <!-- Upload form -->
            <form id="uploadForm" method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label fw-bold">Upload File:</label>
                    <input type="file" class="form-control" id="report" name="report" accept=".pdf,.png,.jpg,.jpeg"
                        required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Output Language:</label>
                    <select class="form-control" id="language" name="language">
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                        <option value="mr">Marathi</option>
                        <option value="gu">Gujarati</option>
                        <option value="ta">Tamil</option>
                        <option value="te">Telugu</option>
                        <option value="kn">Kannada</option>
                        <option value="bn">Bengali</option>
                        <option value="pa">Punjabi</option>
                        <option value="ur">Urdu</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Explanation Level (for medical reports):</label>
                    <select class="form-control" id="explanation_level" name="explanation_level">
                        <option value="simple">Very Simple (for layperson)</option>
                        <option value="normal" selected>Normal</option>
                        <option value="detailed">Detailed (for medical student)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Optional: Describe your symptoms (used only for medical reports)
                    </label>
                    <textarea class="form-control" id="symptoms" name="symptoms" rows="3"
                        placeholder="Example: I feel tired, breathless when climbing stairs, chest heaviness, etc."></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100">
                    Start Agentic Analysis
                </button>
            </form>

            <!-- Progress -->
            <div id="progress-box" class="mt-4 text-center">
                <div class="loader"></div>
                <p class="mt-3 fw-bold" id="status-text">Starting...</p>

                <div class="progress mt-2">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width: 0%;">
                        0%
                    </div>
                </div>

                <button id="retryBtn" class="btn btn-danger mt-3" style="display:none;">
                    Try Again
                </button>
            </div>

            <!-- Result -->
            <div id="result-box" class="mt-4">
                <h5 id="doc-type-label" class="text-muted"></h5>

                <h4 class="mt-2">Ь AI Generated Explanation</h4>
                <div id="summary-html" class="mt-2"></div>

                <div id="graph-box" class="mt-4 text-center"></div>

                <div class="mt-3">
                    <button id="downloadBtn" class="btn btn-success">
                        Download PDF
                    </button>
                    <button id="restartBtn" class="btn btn-secondary ms-2">
                        Analyze Another File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentTaskId = null;
        let pollInterval = null;

        function showToast(message, type = "info") {
            const id = "toast-" + Date.now();
            const color =
                type === "success" ? "bg-success" :
                    type === "error" ? "bg-danger" :
                        type === "warning" ? "bg-warning text-dark" :
                            "bg-info";

            const html = `
        <div id="${id}" class="toast align-items-center text-white ${color} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;

            const container = document.getElementById("toast-container");
            container.insertAdjacentHTML("beforeend", html);

            const toastEl = document.getElementById(id);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            setTimeout(() => toastEl.remove(), 5000);
        }

        function updateProgress(value) {
            const pb = document.getElementById("progress-bar");
            pb.style.width = value + "%";
            pb.innerText = value + "%";
        }

        document.getElementById("uploadForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const fileInput = document.getElementById("report");
            if (!fileInput.files.length) {
                showToast("Please select a file first.", "warning");
                return;
            }

            const formData = new FormData();
            formData.append("report", fileInput.files[0]);
            formData.append("language", document.getElementById("language").value);
            formData.append("explanation_level", document.getElementById("explanation_level").value);
            formData.append("symptoms", document.getElementById("symptoms").value);

            document.getElementById("progress-box").style.display = "block";
            document.getElementById("status-text").innerText = "Uploading...";
            updateProgress(10);

            fetch("/upload", {
                method: "POST",
                body: formData
            })
                .then(r => r.json())
                .then(data => {
                    if (data.task_id) {
                        currentTaskId = data.task_id;
                        showToast("File uploaded. Agentic analysis started.", "success");
                        pollInterval = setInterval(pollStatus, 1500);
                    } else if (data.error) {
                        showToast(data.error, "error");
                    }
                })
                .catch(() => showToast("Upload failed. Please try again.", "error"));
        });

        function pollStatus() {
            if (!currentTaskId) return;

            fetch(`/status/${currentTaskId}`)
                .then(r => r.json())
                .then(task => {
                    if (task.error) {
                        showToast(task.error, "error");
                        clearInterval(pollInterval);
                        document.getElementById("retryBtn").style.display = "block";
                        return;
                    }

                    updateProgress(task.progress || 0);
                    const st = task.status || "processing";
                    document.getElementById("status-text").innerText =
                        st.charAt(0).toUpperCase() + st.slice(1);

                    if (st === "done") {
                        clearInterval(pollInterval);
                        loadResult();
                    }
                })
                .catch(() => showToast("Error checking status.", "error"));
        }

        function loadResult() {
            fetch(`/result/${currentTaskId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, "error");
                        return;
                    }

                    document.getElementById("result-box").style.display = "block";
                    document.getElementById("summary-html").innerHTML = data.summary_html;

                    const docType = data.doc_type || "Other/Unknown";
                    document.getElementById("doc-type-label").innerText =
                        "Detected Document Type: " + docType;

                    if (docType === "Hospital Bill") {
                        document.getElementById("graph-box").innerHTML =
                            "<p class='text-muted'>Visualization not applicable for billing statements.</p>";
                    } else if (data.visualization) {
                        document.getElementById("graph-box").innerHTML = `
                        <h4> Lab Value Visualization</h4>
                        <img src="data:image/png;base64,${data.visualization}"
                             class="img-fluid rounded shadow mt-2"
                             style="max-width: 650px;">
                    `;
                    } else {
                        document.getElementById("graph-box").innerHTML =
                            "<p class='text-muted'>No numeric lab values detected for visualization.</p>";
                    }

                    document.getElementById("downloadBtn").onclick = function () {
                        window.location.href = `/download/${currentTaskId}`;
                    };

                    showToast("Analysis complete!", "success");
                })
                .catch(() => showToast("Error loading result.", "error"));
        }

        document.getElementById("retryBtn").onclick = function () {
            window.location.reload();
        };

        document.getElementById("restartBtn").onclick = function () {
            window.location.reload();
        };
    </script>

</body>

</html>