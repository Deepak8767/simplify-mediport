<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Poppins',sans-serif;background:#f3f6fa;color:#2c3e50;margin:0}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .container{max-width:1000px;margin:28px auto;display:flex;gap:20px;padding:0 20px}
    .left{flex:1}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(135deg,#2b5876,#4e4376);color:#fff;cursor:pointer}
    .btn.secondary{background:#6c7a89}
    .summary-short{margin-top:10px;background:#eef7ff;padding:12px;border-radius:8px}
    .back-link{color:#2b5876;text-decoration:none;font-weight:600}

    /* chat toggle */
    .chat-toggle{position:fixed;right:20px;bottom:20px;width:64px;height:64px;border-radius:50%;background:#2b5876;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.2);cursor:pointer;font-size:28px}
    .chat-panel{position:fixed;right:20px;bottom:100px;width:360px;height:480px;background:#fff;border-radius:12px;box-shadow:0 12px 36px rgba(0,0,0,0.2);display:none;flex-direction:column;overflow:hidden}
    .chat-header{padding:12px;border-bottom:1px solid #eee;background:#fafafa}
    .chat-body{padding:12px;flex:1;overflow:auto}
    .chat-footer{display:flex;padding:8px;border-top:1px solid #eee}
    .chat-footer input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
    .chat-message.user{text-align:right;margin:8px 0}
    .chat-message.assistant{text-align:left;margin:8px 0}
  </style>
</head>
<body>
  <div class="topbar">
    <div><a class="back-link" href="/">‚Üê Back to Home</a></div>
    <div style="font-weight:600">Report Details</div>
    <div></div>
  </div>

  <div class="container">
    <div class="left">
      <div class="card">
        <h3>Assistant Summary</h3>
        <div id="assistant-summary" style="white-space:pre-wrap">{% if output_html %}{{ output_html|safe }}{% else %}<em>No summary generated yet.</em>{% endif %}</div>
        <div id="short-summary" class="summary-short" style="display:none"></div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>Extracted Text</h3>
        <div style="white-space: pre-wrap; background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 500px; overflow-y: auto;">{{ extracted_text }}</div>
      </div>
    </div>

    <div style="width:360px">
      <div class="card">
        <h4>Report Actions</h4>
        <p>Download options and quick actions for this report.</p>
        <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;gap:8px">
              <button id="top-short-summary-btn" class="btn" style="flex:1">Short Summary</button>
              <button id="top-download-simplified" class="btn" style="flex:1">Download Simplified Report</button>
            </div>
            <!-- small preview shown under the top Download Summary button -->
            <div id="top-short-summary-display" class="summary-short" style="display:none;margin-top:8px"></div>
            <!-- Only Short Summary and Simplified Report downloads are shown -->
        </div>
      </div>
    </div>
  </div>

  <div class="chat-toggle" id="chat-toggle">üí¨</div>
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header">Chat about this report</div>
    <div class="chat-body" id="chat-body"></div>
    <div class="chat-footer">
      <input id="chat-input" placeholder="Ask a question..." />
      <button id="chat-send" class="btn">Send</button>
    </div>
  </div>

  <script>
    const taskId = '{{ task_id }}';
    const language = '{{ language }}' || 'English';

    // Short summary (top buttons in Report Actions) ‚Äî populate both the left preview
    // and the small preview under the top Download Summary button.
    document.getElementById('top-short-summary-btn').addEventListener('click', async ()=>{
      const res = await fetch('/short_summary/' + taskId + '?language=' + encodeURIComponent(language));
      const j = await res.json();
      if (j.summary_html){
        // left-side summary (existing)
        const left = document.getElementById('short-summary');
        left.style.display = 'block';
        left.innerHTML = j.summary_html;

        // top-inline preview under the top download button
        const topPreview = document.getElementById('top-short-summary-display');
        if(topPreview){
          topPreview.style.display = 'block';
          topPreview.innerHTML = j.summary_html;
        }
      } else alert('Failed to generate short summary');
    });

    // Download options (only short summary and simplified report)
    document.getElementById('top-download-simplified').addEventListener('click', ()=>{
      window.location = '/download_item/' + taskId + '?what=simplified&language=' + encodeURIComponent(language);
    });

    // left-side simplified download (same as top)
    const leftDownloadSimplified = document.getElementById('left-download-simplified');
    if (leftDownloadSimplified) {
      leftDownloadSimplified.addEventListener('click', ()=>{
        window.location = '/download_item/' + taskId + '?what=simplified&language=' + encodeURIComponent(language);
      });
    }

    // wire left short summary button to reuse top short summary action
    const leftShort = document.getElementById('left-short-summary-btn');
    if (leftShort) leftShort.addEventListener('click', ()=>{ document.getElementById('top-short-summary-btn').click(); });

    // Chat toggle
    const toggle = document.getElementById('chat-toggle');
    const panel = document.getElementById('chat-panel');
    const chatBody = document.getElementById('chat-body');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    toggle.addEventListener('click', ()=>{ panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex'; });

    function appendMessage(role, html){
      const d = document.createElement('div'); d.className = 'chat-message ' + (role==='user'?'user':'assistant'); d.innerHTML = html; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
    }

    chatSend.addEventListener('click', async ()=>{
      const m = chatInput.value.trim(); if(!m) return; appendMessage('user', '<div style="background:#e6f0ff;padding:8px;border-radius:6px;display:inline-block;">'+m+'</div>'); chatInput.value=''; appendMessage('assistant','<em>Thinking...</em>');
      const res = await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})});
      const j = await res.json();
      // remove last thinking
      const as = chatBody.querySelectorAll('.chat-message.assistant'); if(as.length) as[as.length-1].remove();
      if (j.error) appendMessage('assistant','<div style="color:#a00">'+j.error+'</div>'); else appendMessage('assistant', j.reply_html);
    });

    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click(); } });
  </script>
</body>
</html>
